<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Главная страница</title>
    <link rel="stylesheet" th:href="@{/style.css}">
</head>
<body>
<header>
    <div class="header-content">
        <h1>FindYourSeries</h1>
        <nav class="main-nav">
            <a th:href="@{/}" class="nav-link">Главная</a>
            <a th:href="@{/search}" class="nav-link">Поиск</a>
        </nav>
        <div class="auth-section">
            <div th:if="${username}" class="user-info">
                <span th:text="${username}" class="username"></span>
                <form th:action="@{/logout}" method="post" class="logout-form">
                    <button type="submit" class="btn logout-btn">Выйти</button>
                </form>
            </div>
            <div th:unless="${username}" class="auth-buttons">
                <a th:href="@{/login}" class="btn">Войти</a>
                <a th:href="@{/registration}" class="btn">Зарегистрироваться</a>
            </div>
        </div>

    </div>
</header>
<main>

    <h2>Популярные сериалы</h2>
    <section class="series-carousel">
        <button class="carousel-button prev" onclick="moveCarousel(-5)">❮</button>
        <div class="carousel-container">
            <div class="carousel-track" id="carouselTrack">
                <div class="carousel-slide" th:each="series : ${allSeries}">
                    <div class="image-container">
                        <img th:src="${series.seriesImgUrl}" alt="Series poster">
                        <div th:if="${#authentication.principal != 'anonymousUser'}"  class="like-dislike-buttons">
                            <button class="like-btn"
                                    th:onclick="'likeSeries(' + ${series.id} + ')'"
                                    th:classappend="${seriesStatus.get(series.id) == 'LIKE'} ? 'active' : ''">
                            </button>
                            <button class="dislike-btn"
                                    th:onclick="'dislikeSeries(' + ${series.id} + ')'"
                                    th:classappend="${seriesStatus.get(series.id) == 'DISLIKE'} ? 'active' : ''">
                            </button>
                        </div>
                        <div class="series-info">
                            <span class="series-rating" th:text="${series.rating}"></span>
                            <span class="series-seasons-count"
                                  th:text="${series.seasonsCount} + ' сезон'"></span>
                        </div>
                    </div>
                    <span class="series-name" th:text="${series.name}"></span>
                </div>
            </div>
        </div>
        <button class="carousel-button next" onclick="moveCarousel(5)">❯</button>
    </section>

    <div th:if="${#authentication.principal != 'anonymousUser'}">
        <h2>Рекомендация для вас</h2>
        <section th:if="${#lists.size(recommendSeries) >= 10}" class="series-list">
            <div class="list-container">
                <div class="list-items">
                    <div class="list-item" th:each="series : ${allSeries}">
                        <div class="image-container">
                            <img th:src="${series.seriesImgUrl}" alt="Series poster">
                            <div th:if="${#authentication.principal != 'anonymousUser'}"
                                 class="like-dislike-buttons">
                                <button class="like-btn"
                                        th:onclick="'likeSeries(' + ${series.id} + ')'"
                                        th:classappend="${seriesStatus.get(series.id) == 'LIKE'} ? 'active' : ''">
                                </button>
                                <button class="dislike-btn"
                                        th:onclick="'dislikeSeries(' + ${series.id} + ')'"
                                        th:classappend="${seriesStatus.get(series.id) == 'DISLIKE'} ? 'active' : ''">
                                </button>
                            </div>
                            <div class="series-info">
                                <span class="series-rating" th:text="${series.rating}"></span>
                                <span class="series-seasons-count"
                                      th:text="${series.seasonsCount} + ' сезон'"></span>
                            </div>
                        </div>
                        <span class="series-name" th:text="${series.name}"></span>
                    </div>
                </div>
            </div>
        </section>
        <div th:unless="${#lists.size(recommendSeries) >= 10}" class="auth-promo-content">
            <h3>Персонализированные рекомендации</h3>
            <p>Выберите 10 сериалов, которые вам понравились (нажав лайк сериалу), чтобы мы смогли подобрать вам рекомендации,
                также выберете сериалы которые не понравились</p>
        </div>
    </div>
    <div th:unless="${#authentication.principal != 'anonymousUser'}"
         class="auth-promo">
        <div class="auth-promo-content">
            <h3>Персонализированные рекомендации</h3>
            <p>Зарегистрируйтесь, чтобы получать подборки сериалов
                специально для вас!</p>
        </div>
    </div>

</main>

<script>
    const track = document.getElementById('carouselTrack');
    const slides = document.querySelectorAll('.carousel-slide');
    const slideCount = slides.length;
    let currentIndex = 0;
    let isAnimating = false;

    function cloneSlides() {
        const firstSlides = Array.from(slides).slice(0, 5);
        firstSlides.forEach(slide => {
            const clone = slide.cloneNode(true);
            track.appendChild(clone);
        });
    }

    function initCarousel() {
        cloneSlides();
        const slideWidth = slides[0].offsetWidth + 20;
        track.style.width = `${slideWidth * (slideCount + 3)}px`;
    }

    function moveCarousel(direction) {
        if (isAnimating) return;
        isAnimating = true;

        const allSlides = document.querySelectorAll('.carousel-slide');
        const totalSlides = allSlides.length;
        const slideWidth = allSlides[0].offsetWidth + 20;

        currentIndex += direction;

        if (currentIndex >= slideCount) {
            currentIndex = 0;
            track.style.transition = 'transform 0.5s ease';
            track.style.transform = `translateX(-${slideCount * slideWidth}px)`;

            setTimeout(() => {
                track.style.transition = 'none';
                track.style.transform = `translateX(0)`;
                isAnimating = false;
            }, 500);
        }
        else if (currentIndex < 0) {
            currentIndex = slideCount - 1;
            track.style.transition = 'transform 0.5s ease';
            track.style.transform = `translateX(0)`;

            setTimeout(() => {
                track.style.transition = 'none';
                track.style.transform = `translateX(-${(slideCount - 1) * slideWidth}px)`;
                isAnimating = false;
            }, 500);
        }
        else {
            track.style.transition = 'transform 0.5s ease';
            track.style.transform = `translateX(-${currentIndex * slideWidth}px)`;
            setTimeout(() => {
                isAnimating = false;
            }, 500);
        }
    }
    function likeSeries(seriesId) {
        const btn = event.target;
        const dislikeBtn = btn.parentElement.querySelector('.dislike-btn');
        const isCurrentlyActive = btn.classList.contains('active');

        dislikeBtn.classList.remove('active');


        if (isCurrentlyActive) {
            btn.classList.remove('active');
            removeRating(seriesId);
        } else {
            btn.classList.add('active');
            fetch(`/api/series/${seriesId}/like`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            }).then(response => {
                if (!response.ok) {
                    btn.classList.remove('active');
                }
            });
        }

        btn.classList.add('clicked');
        setTimeout(() => btn.classList.remove('clicked'), 300);
    }

    function dislikeSeries(seriesId) {
        const btn = event.target;
        const likeBtn = btn.parentElement.querySelector('.like-btn');
        const isCurrentlyActive = btn.classList.contains('active');

        likeBtn.classList.remove('active');

        if (isCurrentlyActive) {
            btn.classList.remove('active');
            removeRating(seriesId);
        } else {
            btn.classList.add('active');
            fetch(`/api/series/${seriesId}/dislike`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            }).then(response => {
                if (!response.ok) {
                    btn.classList.remove('active');
                }
            });
        }

        btn.classList.add('clicked');
        setTimeout(() => btn.classList.remove('clicked'), 300);
    }

    function removeRating(seriesId) {
        fetch(`/api/series/${seriesId}/remove-rating`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
    }

    window.addEventListener('load', initCarousel);
</script>
</body>